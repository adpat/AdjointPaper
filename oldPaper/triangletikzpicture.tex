\input{triangletikzsetup}

\begin{tikzpicture}
%% =================
% time step 0
%% =================


%% =================
% densities
%% =================

    \begin{pgfonlayer}{celllayer}
        \node (rho1) [clsnode] {$\density{0}{1}$};
        \path (rho1.north)+(0,\clsdist) node (rho2) [clsnode] {$\cdots$};
        \path (rho2.north)+(0,\clsdist) node (rho3) [clsnode] {$\density{\ncell}{0}$};

        \path (rho1.east)+(\clsgrpdist,0) node (l1) [clsnode] {$\rampqueue{1}{0}$};
        \path (l1.north)+(0,\clsdist) node (l2) [clsnode] {$\cdots$};
        \path (l2.north)+(0,\clsdist) node (l3) [clsnode] {$\rampqueue{\ncell-1}{0}$};
    \end{pgfonlayer}

%% =================
% densities box
%% =================

    \begin{pgfonlayer}{varlayer}
        \path (rho3.west |- rho3.north)+(-\varmargin,\varmargin) node (tlvar1) {};
        \path (l1.east |- l1.south)+(\varmargin,-\varmargin) node (brvar1) {};
        \path [varnode] (tlvar1) rectangle (brvar1);
    \end{pgfonlayer}

%% =================
% demands
%% =================


    \begin{pgfonlayer}{celllayer}
        \path (l1.east)+(\vargrpdist,0) node (del1) [clsnode] {$\celldemand{0}{0}$};
        \path (del1.north)+(0,\clsdist) node (del2) [clsnode] {$\cdots$};
        \path (del2.north)+(0,\clsdist) node (del3) [clsnode] {$\celldemand{\ncell}{0}$};

        \path (del1.east)+(\clsgrpdist,0) node (sig1) [clsnode] {$\cellsupply{1}{0}$};
        \path (sig1.north)+(0,\clsdist) node (sig2) [clsnode] {$\cdots$};
        \path (sig2.north)+(0,\clsdist) node (sig3) [clsnode] {$\cellsupply{\ncell}{0}$};
    \end{pgfonlayer}
    \begin{pgfonlayer}{varlayer}
        \path (del3.west |- del3.north)+(-\varmargin,\varmargin) node (tlvar2) {};
        \path (sig1.east |- sig1.south)+(\varmargin,-\varmargin) node (brvar2) {};
        \path [varnode] (tlvar2) rectangle (brvar2);
        \path [myarrow] (l2.east -| brvar1) -- (del2.west -| tlvar2);
    \end{pgfonlayer}

%% =================
% flow ins
%% =================


    \begin{pgfonlayer}{celllayer}
        \path (sig1.east)+(\vargrpdist,0) node (fin1) [clsnode] {$\flowin{1}{0}$};
        \path (fin1.north)+(0,\clsdist) node (fin2) [clsnode] {$\cdots$};
        \path (fin2.north)+(0,\clsdist) node (fin3) [clsnode] {$\flowin{\ncell}{0}$};
    \end{pgfonlayer}
    \begin{pgfonlayer}{varlayer}
        \path (fin3.west |- fin3.north)+(-\varmargin,\varmargin) node (tlvar3) {};
        \path (fin1.east |- fin1.south)+(\varmargin,-\varmargin) node (brvar3) {};
        \path [varnode] (tlvar3) rectangle (brvar3);
        \path [myarrow] (sig2.east -| brvar2) -- (tlvar3 |- fin2.west);
    \end{pgfonlayer}

%% =================
% flow outs
%% =================

    \begin{pgfonlayer}{celllayer}
        \path (fin1.east)+(\vargrpdist,0) node (fout1) [clsnode] {$\flowout{1}{0}$};
        \path (fout1.north)+(0,\clsdist) node (fout2) [clsnode] {$\cdots$};
        \path (fout2.north)+(0,\clsdist) node (fout3) [clsnode] {$\flowout{\ncell-1}{0}$};
    \end{pgfonlayer}
    \begin{pgfonlayer}{varlayer}
        \path (fout3.west |- fout3.north)+(-\varmargin,\varmargin) node (tlvar4) {};
        \path (fout1.east |- fout1.south)+(\varmargin,-\varmargin) node (brvar4) {};
        \path [varnode] (tlvar4) rectangle (brvar4);
        \path [myarrow] (fin2.east -| brvar3) -- (tlvar4 |- fout2.west);
    \end{pgfonlayer}

%% =================
% ramps
%% =================

    \begin{pgfonlayer}{celllayer}
        \path (fout1.east)+(\vargrpdist,0) node (r1) [clsnode] {$\rampflow{1}{0}$};
        \path (r1.north)+(0,\clsdist) node (r2) [clsnode] {$\cdots$};
        \path (r2.north)+(0,\clsdist) node (r3) [clsnode] {$\rampflow{\ncell-1}{0}$};
    \end{pgfonlayer}
    \begin{pgfonlayer}{varlayer}
        \path (r3.west |- r3.north)+(-\varmargin,\varmargin) node (tlvar5) {};
        \path (r1.east |- r1.south)+(\varmargin,-\varmargin) node (brvar5) {};
        \path [varnode] (tlvar5) rectangle (brvar5);
        \path [myarrow] (fout2.east -| brvar4) -- (tlvar5 |- r2.west);
    \end{pgfonlayer}

%% =================
% time box
%% =================


    \begin{pgfonlayer}{timelayer}
        \path (tlvar1)+(-\timemargin,\timemargin) node (tltime1) {};
        \path (brvar5)+(\timemargin,-\timemargin*3) node (brtime1) {};
        \path [timenode] (tltime1) rectangle (brtime1) node (varbox) {};
        \gettikzxy{(brtime1)}{\bx}{\by};
        \gettikzxy{(tltime1)}{\tx}{\ty};
        \path [text centered] (brtime1)+(\tx*.5 - \bx*.5,.3) node (timelabel1) {Time 0};
    \end{pgfonlayer}


%% =================
% time step N
%% =================


    \begin{pgfonlayer}{celllayer}
        \path (rho1.south)+(0,-\timegrpdist) node (rho1) [clsnode] {$\density{1}{\ntime}$};
        \path (rho1.north)+(0,\clsdist) node (rho2) [clsnode] {$\cdots$};
        \path (rho2.north)+(0,\clsdist) node (rho3) [clsnode] {$\density{\ncell}{\ntime}$};

        \path (rho1.east)+(\clsgrpdist,0) node (l1) [clsnode] {$\rampqueue{1}{\ntime}$};
        \path (l1.north)+(0,\clsdist) node (l2) [clsnode] {$\cdots$};
        \path (l2.north)+(0,\clsdist) node (l3) [clsnode] {$\rampqueue{\ncell-1}{\ntime}$};
    \end{pgfonlayer}
    \begin{pgfonlayer}{varlayer}
        \path (rho3.west |- rho3.north)+(-\varmargin,\varmargin) node (tlvar1) {};
        \path (l1.east |- l1.south)+(\varmargin,-\varmargin) node (brvar1) {};
        \path [varnode] (tlvar1) rectangle (brvar1);
    \end{pgfonlayer}

    \begin{pgfonlayer}{celllayer}
        \path (l1.east)+(\vargrpdist,0) node (del1) [clsnode] {$\celldemand{0}{\ntime}$};
        \path (del1.north)+(0,\clsdist) node (del2) [clsnode] {$\cdots$};
        \path (del2.north)+(0,\clsdist) node (del3) [clsnode] {$\celldemand{\ncell}{\ntime}$};

        \path (del1.east)+(\clsgrpdist,0) node (sig1) [clsnode] {$\cellsupply{1}{\ntime}$};
        \path (sig1.north)+(0,\clsdist) node (sig2) [clsnode] {$\cdots$};
        \path (sig2.north)+(0,\clsdist) node (sig3) [clsnode] {$\cellsupply{\ncell}{\ntime}$};
    \end{pgfonlayer}
    \begin{pgfonlayer}{varlayer}
        \path (del3.west |- del3.north)+(-\varmargin,\varmargin) node (tlvar2) {};
        \path (sig1.east |- sig1.south)+(\varmargin,-\varmargin) node (brvar2) {};
        \path [varnode] (tlvar2) rectangle (brvar2);
        \path [myarrow] (l2.east -| brvar1) -- (del2.west -| tlvar2);
    \end{pgfonlayer}

    \begin{pgfonlayer}{celllayer}
        \path (sig1.east)+(\vargrpdist,0) node (fin1) [clsnode] {$\flowin{1}{\ntime}$};
        \path (fin1.north)+(0,\clsdist) node (fin2) [clsnode] {$\cdots$};
        \path (fin2.north)+(0,\clsdist) node (fin3) [clsnode] {$\flowin{\ncell}{\ntime}$};
    \end{pgfonlayer}
    \begin{pgfonlayer}{varlayer}
        \path (fin3.west |- fin3.north)+(-\varmargin,\varmargin) node (tlvar3) {};
        \path (fin1.east |- fin1.south)+(\varmargin,-\varmargin) node (brvar3) {};
        \path [varnode] (tlvar3) rectangle (brvar3);
        \path [myarrow] (sig2.east -| brvar2) -- (tlvar3 |- fin2.west);
    \end{pgfonlayer}


    \begin{pgfonlayer}{celllayer}
        \path (fin1.east)+(\vargrpdist,0) node (fout1) [clsnode] {$\flowout{1}{\ntime}$};
        \path (fout1.north)+(0,\clsdist) node (fout2) [clsnode] {$\cdots$};
        \path (fout2.north)+(0,\clsdist) node (fout3) [clsnode] {$\flowout{\ncell-1}{\ntime}$};
    \end{pgfonlayer}
    \begin{pgfonlayer}{varlayer}
        \path (fout3.west |- fout3.north)+(-\varmargin,\varmargin) node (tlvar4) {};
        \path (fout1.east |- fout1.south)+(\varmargin,-\varmargin) node (brvar4) {};
        \path [varnode] (tlvar4) rectangle (brvar4);
        \path [myarrow] (fin2.east -| brvar3) -- (tlvar4 |- fout2.west);
    \end{pgfonlayer}


    \begin{pgfonlayer}{celllayer}
        \path (fout1.east)+(\vargrpdist,0) node (r1) [clsnode] {$\rampflow{1}{\ntime}$};
        \path (r1.north)+(0,\clsdist) node (r2) [clsnode] {$\cdots$};
        \path (r2.north)+(0,\clsdist) node (r3) [clsnode] {$\rampflow{\ncell-1}{\ntime}$};
    \end{pgfonlayer}
    \begin{pgfonlayer}{varlayer}
        \path (r3.west |- r3.north)+(-\varmargin,\varmargin) node (tlvar5) {};
        \path (r1.east |- r1.south)+(\varmargin,-\varmargin) node (brvar5) {};
        \path [varnode] (tlvar5) rectangle (brvar5);
        \path [myarrow] (fout2.east -| brvar4) -- (tlvar5 |- r2.west);
    \end{pgfonlayer}





    \begin{pgfonlayer}{timelayer}
        \path (tlvar1)+(-\timemargin,\timemargin) node (tltime2) {};
        \path (brvar5)+(\timemargin,-\timemargin*3) node (brtime2) {};
        \path [timenode] (tltime2) rectangle (brtime2) node (varbox) {};
        \gettikzxy{(brtime2)}{\bxtwo}{\bytwo};
        \gettikzxy{(tltime2)}{\txtwo}{\tytwo};
        \path [text centered] (brtime2)+(\txtwo*.5 - \bxtwo*.5,.3) node (timelabel2) {Time $\ntime$};
    \end{pgfonlayer}


%% =================
% end time step N
%% =================


%% =================
% intermediate times
%% =================


    \begin{pgfonlayer}{timelayer}
        \gettikzxy{(brtime2)}{\bxtwo}{\bytwo};
        \gettikzxy{(tltime2)}{\txtwo}{\tytwo};
        \gettikzxy{(brtime1)}{\bx}{\by};
        \gettikzxy{(tltime1)}{\tx}{\ty};
        \path (tltime2)+(\bx*.5-\tx*.5,\by*.5 - \tytwo*.5) node (timedots) {Time $\itime\cdots$};
        \path [myarrow] (brtime1)+(\tx*.5 - \bx*.5,0) -- (timedots);
        \path (tltime2)+(\bx*.5 - \tx*.5,0) node (top2arrow) {};
        \path [myarrow] (timedots) -- (top2arrow);
    \end{pgfonlayer}


%% =================
% end intermediate times
%% =================


\end{tikzpicture}