% !TEX root = rampMeteringViaTheAdjoint.tex

The state variables $x$ contains two variables $\rho$ and $l$ that the objective function $J$ depends on. Therefore, $\frac{\partial J}{\partial x}$ is a row vector of length $\left | {x} \right |$ with zero's in all the partial derivative with respect to all other variables of the state vector. 

\begin{align*}
\frac{\partial J}{\partial x_0(k)} &= (1, 0, 0)& \\
\frac{\partial J}{\partial x_i(k)} &= (1, 0, 0, 0, 0, 0, 0, 1)& \\
\frac{\partial J}{\partial x_N(k)} &= (1, 0, 0)&
\end{align*}

%\begin{equation}
%\frac{\partial J(k)}{\partial x(k)} = \left( \frac{\partial J_0(k)}{\partial x_0(k)} , \cdots, \frac{\partial J_i(k)}{\partial x_i(k)}, \cdots, \frac{\partial J_N(k)}{\partial x_N(k)} \right)
%\end{equation}

%\begin{equation}
%\frac{\partial J}{\partial x} = \left( \frac{\partial J(0)}{\partial x(0)}, \cdots , \frac{\partial J(k)}{\partial x(k)}, \cdots , \frac{\partial J(T-1}{\partial x(T-1)} \right)
%\end{equation}


The matrix $\frac{\partial H}{\partial x}$ is given in sparse, tabular
format in Table~\ref{tab:Sparse-format-of}.
\begin{longtable}{|c|c|l|}
\hline 
Constraint & Variable & Partial Derivative\tabularnewline
\hline 
\hline 
$\H{1}{\itime}{\icell}$ & $\density{\icell}{\itime}$ & 1\tabularnewline
\hline 
& $\density{\icell}{\itime-1}$ & -1\tabularnewline
\hline 
& $\flowin{\icell}{\itime-1}$ & -$\frac{\deltat}{\deltax}$\tabularnewline
\hline 
&$\flowout{\icell}{\itime-1}$ & $\frac{\deltat}{\deltax}$\tabularnewline
\hline 
\hline 
$\H{1}{\itime}{0}$ & $\density 0{\itime}$ & 1\tabularnewline
\hline 
& $\density 0{\itime-1}$ & -1\tabularnewline
\hline 
& $\flowout 0{\itime-1}$ & $\frac{\deltat}{\deltax}$\tabularnewline
\hline 
\hline 
$\H{1}{\itime}{\ncell}$ & $\density{\ncell}{\itime}$ & 1\tabularnewline
\hline 
& $\density N{\itime-1}$ & -1\tabularnewline
\hline 
& $\flowout N{\itime-1}$ & -$\frac{\deltat}{\deltax}$\tabularnewline
\hline 
& $\celldemand{\ncell}{\itime}$ & $\frac{\deltat}{\deltax}$\tabularnewline
\hline
\hline 
$\H{1}{0}{\icell}$ & $\density{\icell}{0}$ & 1\tabularnewline
\hline 
\hline 
$\H{2}{\itime}{\icell}$ & $\rampqueue{\icell}{\itime}$ & 1\tabularnewline
\hline 
& $\rampqueue{\icell}{\itime-1}$ & -1\tabularnewline
\hline 
& $\rampflow{\icell}{\itime}$ & $\deltat$ \tabularnewline
\hline 
\hline 
$\H{2}{0}{\icell}$ & $\rampqueue{\icell}0$ & 1\tabularnewline
\hline 
\hline 
$\H{3}{\itime}{\icell}$ & $\celldemand{\icell}{\itime}$ & 1\tabularnewline
\hline 
& $\density{\icell}{\itime}$& $\begin{cases}
-\ffspeed{\icell} & \ffspeed{\icell}\density{\icell}{\itime}<\fmax{\icell}\\
0 & \text{otherwise}
\end{cases}$\tabularnewline
\hline 
\hline 
$\H{4}{\itime}{\icell}$ & $\cellsupply{\icell}{\itime}$ & 1\tabularnewline
\hline 
& $\density{\icell}{\itime}$ & $\begin{cases}
\congspeed{\icell} & \congspeed{\icell}\left(\jamdensity{\icell}-\density{\icell}{\itime}\right)<\fmax{\icell}\\
0 & \text{otherwise}
\end{cases}$\tabularnewline
\hline 
\hline 
$\H{5}{\itime}{\icell}$ & $\rampdemand{\icell}{\itime}$ & 1\tabularnewline
\hline 
& $\rampqueue{\icell}{\itime}$ & $\begin{cases}
-1 & \rampqueue{\icell}{\itime}<\rampcontrol{\icell}{\itime}\\
0 & \text{otherwise}
\end{cases}$\tabularnewline
\hline 
\hline 
$\H{6}{\itime}{\icell}$ & $\flowin{\icell}{\itime}$ & 1\tabularnewline
\hline 
& $\rampdemand{\icell-1}{\itime}$ & $\begin{cases}
-1 & \celldemand{\icell-1}{\itime}\left(1-\offrampratio{\icell-1}{\itime}\right)+\rampdemand{\icell-1}{\itime}<\cellsupply{\icell}{\itime}\\
0 & \text{otherwise}
\end{cases}$\tabularnewline
\hline 
& $\celldemand{\icell-1}{\itime}$ & $\begin{cases}
-\left(1-\offrampratio{\icell-1}{\itime}\right) & \celldemand{\icell-1}{\itime}\left(1-\offrampratio{\icell-1}{\itime}\right)+\rampdemand{\icell-1}{\itime}<\cellsupply{\icell}{\itime}\\
0 & \text{otherwise}
\end{cases}$\tabularnewline
\hline 
& $\cellsupply{\icell}{\itime}$ & $\begin{cases}
-1 & \cellsupply{\icell}{\itime}\le\celldemand{\icell-1}{\itime}\left(1-\offrampratio{\icell-1}{\itime}\right)+\rampdemand{\icell-1}{\itime}\\
0 & \text{otherwise}
\end{cases}$\tabularnewline
\hline 
\hline 
$\H{6}{\itime}{1}$ & $\flowin 1{\itime}$ & 1\tabularnewline
\hline 
& $\celldemand 0{\itime}$ & $\begin{cases}
-1 & \celldemand 0{\itime}<\cellsupply{\icell}{\itime}\\
0 & \text{otherwise}
\end{cases}$\tabularnewline
\hline 
& $\cellsupply 0{\itime}$ & $\begin{cases}
-1 & \cellsupply{\icell}{\itime}\le\celldemand 0{\itime}\\
0 & \text{otherwise}
\end{cases}$\tabularnewline
\hline 
\hline 
$\H{7}{\itime}{\icell}$ & $\flowout{\icell}{\itime}$ & 1\tabularnewline
\hline 
& $\flowin{\icell+1}{\itime}$ & $\begin{cases}
\frac{-1}{\left(1-\offrampratio{\icell}{\itime}\right)} & \text{Case 1, 4}\\
-\frac{\priority{\icell}}{\left(1-\offrampratio{\icell}{\itime}\right)} & \text{Case 5}\\
0 & \text{otherwise}
\end{cases}$\tabularnewline
\hline 
& $\celldemand{\icell}{\itime}$ & $\begin{cases}
-\frac{1}{\left(1-\offrampratio{\icell}{\itime}\right)} & \text{Case 2,3}\\
0 & \text{otherwise}
\end{cases}$\tabularnewline
\hline 
& $\rampdemand{\icell}{\itime}$ & $\begin{cases}
1 & \text{Case 4}\\
0 & \text{otherwise}
\end{cases}$\tabularnewline
\hline 
\hline 
$\H{7}{\itime}{0}$ & $\flowout 0{\itime}$ & 1\tabularnewline
\hline 
& $\flowin 1{\itime}$ & -1\tabularnewline
\hline 
\hline 
$\H{8}{\itime}{\icell}$ & $\rampflow{\icell}{\itime}$ & 1\tabularnewline
\hline 
& $\flowin{\icell+1}{\itime}$ & -1\tabularnewline
\hline 
& $\flowout{\icell}{\itime}$ & $\left(1-\offrampratio{\icell}{\itime}\right)$\tabularnewline
\hline 
\caption{\label{tab:Sparse-format-of}Sparse format of $\frac{\partial H(i,k)}{\partial x}$}
\end{longtable}

