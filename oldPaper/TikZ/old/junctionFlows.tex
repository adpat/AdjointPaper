\documentclass[10pt]{article}
\usepackage{calc}
\usepackage[usenames,dvipsnames]{xcolor}
\definecolor{lightgray}{gray}{0.9}

\usepackage{tikz}
\usetikzlibrary{calc}
\usepackage{xparse}
\usepackage{etoolbox}
\usepackage[graphics, tightpage, active]{preview}
\usepackage{amsmath}


\usetikzlibrary{decorations.pathreplacing}


\setlength{\PreviewBorder}{2pt}
\PreviewEnvironment{tikzpicture}


\input{../commands.tex}


%============================================================================================
%Additional commands

\newcommand \trim[4]{
\renewcommand \PreviewBbAdjust{#1 #2 #3 #4}
}

\newcommand \scale{2}
\newcommand \bound[1]{\Big(1 - \frac{\maxR{#1}}{r} \Big)}
\newcommand \tick[2]{
(#2, #1) -- (#2, -#1)
}

\newcommand \smalltick[1]{\tick{0.01}{#1}}
\newcommand \largetick[1]{[line width=1pt]\tick{0.02}{#1}}

\tikzset{dashdot/.style={dash pattern=on 2pt off 3pt on 4pt off 3pt}}

\makeatletter
\newcommand{\gettikzxy}[3]{%
  \tikz@scan@one@point\pgfutil@firstofone#1\relax
  \edef#2{\the\pgf@x}%
  \edef#3{\the\pgf@y}%
}
\makeatother

%============================================================================================
\begin{document}
%============================================================================================

\begin{tikzpicture}[scale=\scale,domain=0:1]

\def \rampDem{2}
\def \dem{2.5}
\def \priorityRat{0.7}
\def \splitRat{0.4}
\def \totalFlow{2.1}

\coordinate (Z) at (0,0);
\coordinate (I1) at (\rampDem, 0);
\coordinate (I2) at (0, \dem);
\coordinate (I3) at (\rampDem, \dem);
\coordinate (A) at (0, {\totalFlow/(1-\splitRat)});
\coordinate (B) at (\totalFlow, 0);
\coordinate (C) at ({(1-\priorityRat)/\priorityRat*\dem}, \dem);
\coordinate (P) at (intersection of A--B and I2--I3);

\draw[->] (Z) -- (3.5,0) node[below right]{$\rampflow{\icell}{\itime}$};
\draw[->] (Z) -- (0,4) node[left]{$\flowout{\icell}{\itime}$};
\draw[dashed] (I3) -- (I1) node[below]{$\rampdemand{\icell}{\itime}$};
\draw[dashed] (I3) -- (I2) node[left]{$\celldemand{\icell}{\itime}$};
\draw (A) -- (B) node[yshift=1cm, xshift=1cm]{$(1-\offrampratio{\icell}{\itime})\flowout{\icell}{\itime} + \rampflow{\icell}{\itime} = \flowin{\icell+1}{\itime}$};
\draw (P) circle (1pt);

\gettikzxy{(P)}{\Px}{\Py}
\draw[dashdot, color=Green] (0, {\Px + \Py}) -- ({\Px + \Py}, 0) node [xshift=-0cm, yshift=2cm]{$\flowout{\icell}{\itime} + \rampflow{\icell}{\itime} = const$};

\end{tikzpicture}


\end{document}
