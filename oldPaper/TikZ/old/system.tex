\documentclass[10pt]{article}
\usepackage{calc}
\usepackage[usenames,dvipsnames]{xcolor}
\definecolor{lightgray}{gray}{0.9}

\usepackage{tikz}
\usetikzlibrary{calc}
\usepackage{xparse}
\usepackage{etoolbox}
\usepackage[graphics, tightpage, active]{preview}
\usepackage{amsmath}


\usetikzlibrary{decorations.pathreplacing}


\setlength{\PreviewBorder}{2pt}
\PreviewEnvironment{tikzpicture}


\input{../commands.tex}


%============================================================================================
%Additional commands

\newcommand \trim[4]{
\renewcommand \PreviewBbAdjust{#1 #2 #3 #4}
}

\newcommand \scale{1}
\newcommand \bound[1]{\Big(1 - \frac{\maxR{#1}}{r} \Big)}
\newcommand \tick[2]{
(#2, #1) -- (#2, -#1)
}

\newcommand \smalltick[1]{\tick{0.01}{#1}}
\newcommand \largetick[1]{[line width=1pt]\tick{0.02}{#1}}


\newcommand*{\ExtractCoordinate}[1]{\path (#1); \pgfgetlastxy{\XCoord}{\YCoord};}%


%============================================================================================
\begin{document}
%============================================================================================

\begin{tikzpicture}[scale=\scale,domain=0:1]

\def \linkWidth {1cm}
\def \nodeWidth {0.3cm}

\coordinate (arrow) at (1.8,0);
\coordinate (dots) at (0.5,0);
\coordinate (unit) at (2.5,0);

\node (link0) at (0,0) [rectangle, minimum width=\linkWidth, draw] {$0$};
\node (link1) at ($(link0) + 1*(unit)$) [rectangle, minimum width=\linkWidth, draw] {$1$};
\node (linkI) at ($(link1) + 2*(unit)$) [rectangle, minimum width=\linkWidth, draw] {$\icell$};
\node (nodeI) at ($(linkI) + 1*(unit)$) [circle, minimum width=\nodeWidth, draw] {$\icell$};

\node (onrampI) at ($(linkI)-(0,0.8)$) [rectangle, minimum width=\linkWidth, draw] {on-ramp $\icell$};
\node (offrampI) at ($(linkI) + 1.4*(unit) - (0,0.5)$) {};

\node (linkI1) at ($(nodeI) + 1.45*(unit)$) [rectangle, minimum width=\linkWidth, draw] {$\icell+1$};

\node (linkN) at ($(linkI1)+1.8*(unit)$) [rectangle, minimum width=\linkWidth, draw] {$\ncell$};

% link 0
\draw[->] ($(link0)-(arrow)$) -- (link0) node[above, midway] {$\inputflux{0}{\itime}$};
\draw[->] (link0) -- (link1) node[above, midway] {$\flowout{0}{\itime}$};

% link 1
\draw[->] (link1) -- ($(link1) + (arrow)$) node[above, midway] {$\flowout{1}{\itime}$};

%dots
\draw ($(link1) + (arrow) + (dots)$) node{$\dots$} ;

% link i
\draw[->] ($(linkI) - 1.3*(arrow)$) -- (linkI)node[above, xshift=-1.1cm] {$\flowin{\icell}{\itime}$};
\draw[->] (linkI) -- (nodeI) node[above, midway] {$\flowout{\icell}{\itime}$};
\draw[->] (nodeI) -- (linkI1) node[above, xshift=-1.1cm]{$\flowin{\icell+1}{\itime}$} ;

%node i
\draw[->] (onrampI) [anchor=right]-- (nodeI) node[below, midway]{$\rampflow{\icell}{\itime}$};
\draw[->] ($(onrampI) - (arrow)$) [anchor=right]-- (onrampI) node[above, midway]{$\inputflux{\icell}{\itime}$};
\draw[->] (nodeI) -- (offrampI) node[below, xshift=-0.3cm]{$\offrampratio{\icell}{\itime} \flowout{\icell}{\itime}$};

%link i+1
\draw[->] (linkI1) -- ($(linkI1) + (arrow)$) node[above, midway] {$\flowout{\icell+1}{\itime}$};

%dots
\draw ($(linkI1)+(arrow)+(dots)$) node{$\dots$} ;

% link N
\draw[->] ($(linkN) - (arrow)$) -- (linkN) node[above, midway] {$\flowin{\ncell}{\itime}$};
\draw[->] (linkN)--($(linkN) + (arrow)$) node[above, midway] {$\flowout{\ncell}{\itime}$};

% box
\draw[dashed] ($(linkI) + (-2,1)$) rectangle ($(nodeI) + (1.8,-1.5)$) node[below]{block $\icell$};

\end{tikzpicture}


\end{document}
