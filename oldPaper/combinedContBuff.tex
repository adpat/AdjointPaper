% !TEX root = rampMeteringViaTheAdjoint.tex
This is an attempt to combine the work of the previous two main sections, as discussed the other day.
\paragraph{Definitions}
\input{contJunctionFigure}
Parameters/Setup
\begin{itemize}
\item $\delta_{1}\left(\cdot\right),\sigma_{2}\left(\cdot\right),D,\beta,P,r^{\max}$
\item $I=\left\{ 1,r\right\} ,J=\left\{ 2\right\} $
\begin{itemize}
\item See Figure~\ref{fig:contJuncIll}
\end{itemize}
\end{itemize}
Max Flux
\begin{itemize}
\item $\gamma_{1,t}^{\max}=\delta_{1}\left(\rho_{1,t}\right),\gamma_{2,t}^{\max}=\sigma_{2}\left(\rho_{2,t}\right)$
\item $\gamma_{r,t}^{\max}=\begin{cases}
r^{\max} & l_{t}>0\\
\min\left(r^{\max},D\right) & \text{otherwise}
\end{cases}$
\item $\Gamma^{\max}\left(\rho_{1,t},\rho_{2,t},l_{t}\right)=$$\left(\gamma_{1,t}^{\max},\gamma_{2,t}^{\max},\gamma_{r,t}^{\max}\right)$
\item $\Omega_{i,t}=\left[0,\gamma_{i,t}^{\max}\right]$
\end{itemize}
Junction Problem
\begin{itemize}
\item $\mathcal{JS}\left(\gamma_{1}^{\max},\gamma_{2}^{\max},\gamma_{r}^{\max}\right)=\left(\gamma_{1},\gamma_{2},\gamma_{r}\right)$
is detailed in Section~\ref{sub:junction-model}
\end{itemize}
Mapping from fluxes to boundary densities
\begin{itemize}
\item $\psi_{1,t}\left(\gamma\right)=\rho_{1,t^{+}},\psi_{2,t}\left(\gamma\right)=\rho_{2,t^{+}}$
are described in Piccoli book
\item $\psi_{r,t}\left(\gamma\right)=l_{t^{+}}=l_t + \left(D-\gamma\right)\delta t$
\item $\Psi_{t}\left(\gamma_{1},\gamma_{2},\gamma_{r}\right)=\left(\psi_{i,t}\left(\gamma_{i}\right):i\in\left(1,2,r\right)\right)$
\end{itemize}
Riemann Solver
\begin{itemize}
\item $\mathcal{RS}\left(\rho_{1,t},\rho_{2,t},l_{t}\right)=\Psi\left(\mathcal{JS}\left(\Gamma^{\max}\left(\rho_{1,t},\rho_{2,t},l_{t}\right)\right)\right)=\left(\rho_{1,t^{+}},\rho_{2,t^{+}},l_{t^{+}}\right)$
\end{itemize}
Limiting Side: Whether demand or supply limits flux across junction
\begin{itemize}
\item $\mathcal{LS}_{t}=\begin{cases}
I & \gamma_{1,t}^{\max}\beta+\gamma_{r,t}^{\max}<\gamma_{2,t}^{\max}\\
J & \text{otherwise}
\end{cases}$
\item $\bar{\mathcal{LS}_{t}}=\begin{cases}
J & \gamma_{1,t}^{\max}\beta+\gamma_{r,t}^{\max}<\gamma_{2,t}^{\max}\\
I & \text{otherwise}
\end{cases}$
\end{itemize}
\textbf{Remark:} We do not consider the case where the queue instantaneously
goes from non-empty to empty. This would be the case where the initial shock and the emptying shock occur simultaneously, but this cannot be the case since there will always be a finite gap between the shocks, at which we could consider two separate Riemann problems.


\paragraph{Proof of self-similarity}
\begin{itemize}
\item $\gamma_{i}=\gamma_{i}^{\max}\implies\Omega_{i,0^{+}}=\Omega_{i,0}$

\begin{itemize}
\item For density links, this is a property of the $\psi$ mapping in Piccoli.
It is clear that the only time this may not be the case for the buffer
is when the buffer goes from empty to non-empty. But for this to be
the case, $D>r^{\max}=\gamma_{r,0}^{\max}$, therefore $\gamma_{r,0}^{\max}=\min\left(D,r^{\max}\right)=r^{\max}=\gamma_{r,0^{+}}^{\max}$.
\end{itemize}
\item $\forall i\in\mathcal{LS}_{0}\implies\Omega_{i,0^{+}}=\Omega_{i,0}$

\begin{itemize}
\item This follows from the property above and the properties of $\psi$.
\end{itemize}
\item $\forall i\in\bar{\mathcal{LS}}_{0}\implies\Omega_{i,0}\subseteq\Omega_{i,0^{+}}$

\begin{itemize}
\item For the density links, from the properties of $\psi$, when a link
is below its maximum flux, its maximum flux will only increase, i.e.
the upstream links become more congested, and the downstream links
become less congested. For the buffer, clearly $\forall D,r^{\max}:r^{\max}\ge\min\left(D,r^{\max}\right)$.
\end{itemize}
\item $\mathcal{LS}_{0^{+}}=\mathcal{LS}_{0}$

\begin{itemize}
\item This follows from the fact that the limiting side's feasible set remains
the same, while the non limiting side's feasible set only increases,
therefore the limiting side for time 0 will again be limiting for
$0^{+}$.
\end{itemize}
\item $\gamma_{i,0^{+}}=\gamma_{i,0}\forall i\in\left\{ 1,2,r\right\} \implies\mathcal{RS}$
is self similar

\begin{itemize}
\item From the properties of $\Psi$ and $\mathcal{JS}$, we have the property
that $\Psi_{t^{+}}\left(\gamma_{1,t},\gamma_{2,t},\gamma_{r,t}\right)=\left(\rho_{1,t^{+}},\rho_{2,t^{+}},\rho_{r,t^{+}}\right)$. Then we have:
\end{itemize}
\end{itemize}
\begin{eqnarray*}
\gamma_{0^{+}} & =\gamma_{0} & \implies\\
\rho_{0^{++}}=\Psi_{0^{+}}\left(\gamma_{0^{+}}\right)=\Psi_{0^{+}}\left(\gamma_{0}\right) & = & \rho_{0^{+}}
\end{eqnarray*}


\textbf{Theorem: }$\mathcal{RS}$ is self similar

\textbf{Proof:} We only need to show that $\gamma_{i,0^{+}}=\gamma_{i,0}\forall i\in\left\{ 1,2,r\right\} $.
When the problem is demand-limited, it is true from the fact that
the feasible set does not change for the limiting side (and the limiting
side does not change). When the problem is supply-limited, we have
that the incoming fluxes are determined by minimizing the distance of the incoming flux solution $\left(\gamma_{1},\gamma_{r}\right)$ from the intersection of $P$ line and the outgoing feasible set (Figure~\ref{fig:ssDistance}),
such that the total flux is maximized and feasible. Since the outgoing
feasible set and the $P$ value do not change, this intersection point
will not change between $t=0$ and $0^{+}$.

We consider the case when the intersection point occurs on the interior
of the incoming feasible set, and otherwise. For the first case, the
reference point is feasible, and thus reference point will be optimal
for both the original and final problem. See Figure~\ref{fig:virtualSSInteriorComb}.

Otherwise, exactly one of the incoming links $i\in\left\{ 1,r\right\} $
has $\gamma_{i,0}=\gamma_{i,0}^{\max}$, and the optimal point of
the problem at $t=0$ resides on the boundary of the feasible region.
Therefore $\Omega_{i,0}=\Omega_{i,0^{+}}$, and $\Omega_{j,0^{+}}\subseteq\Omega_{j,0}$,
where $j\in\left\{ 1,r\right\} \setminus\left\{ i\right\} $ is the
other incoming link. Therefore the flux solutions at time $t=0$ ($\gamma_0$) remain
feasible and on the boundary of the feasible set. Since our objective
is convex and the feasible set does not increase locally at $\gamma_{0}$,
the flux solution from $\mathcal{JS}$ at $t=0^{+}$ will equivalently
be $\gamma_{0}$. See Figure~\ref{fig:virtualSSBoundaryComb}.

For all initial data, we have demonstrated $\gamma_{i,0^{+}}=\gamma_{i,0}\forall i\in\left\{ 1,2,r\right\} $,
thus completing the proof.

\input{combinedSSFigure}
