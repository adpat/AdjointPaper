% !TEX root = SO-DTA with partial compliance.tex

We wish to minimize the total travel time of the system (system optimal) subject to the boundary conditions of the network, the flow propagation model constraints, junction model constraints and the partial controllability of vehicle route choice. A fixed percentage $\compliantratiomc{c}$ of vehicles can be controlled for each commodity $c$. 

The system equations are written formally in the form $H(x,u)=0$. The discretized system can be described using eight types of constraints, given by $\H{x}{\itime}{\icell} = 0$ for $x \in \{1, \dots, 8\}$, where we index each equality constraint by time index $\itime$, and cell index $\icell$. We now give the system equations.

\begin{align}
&\min \sum_{i\in{\cal I}, k\in{\cal T}} \density{i}{k} \nonumber \\
&\text{subject to} \nonumber \\
&\ \ \textit{mass conservation constraints} \nonumber \\
&\ \ \textit{boundary constraints} \nonumber \\
&\ \ \textit{flow propagation constraints} \nonumber \\
&\ \ \textit{junction constraints}  \nonumber 
\end{align}

We assume that the FIFO condition at the source boundaries can be approximated by a single large buffer.\\


% Equation number stuff
%-----------------------------------------------------------------------------------------------------------------------------------------------------------------
\newcounter{oldequation}
\setcounter{oldequation}{\theequation}
\setcounter{equation}{0}
\renewcommand{\theequation}{H\arabic{equation}}
%-----------------------------------------------------------------------------------------------------------------------------------------------------------------
% !TEX root = SO-DTA with partial compliance.tex


\noindent \textbf{Mass conservation}
\begin{subequations}
\begin{align}
\Hmc{1}{\itime}{\icell}{\commoditysymbol}: && \densitymc{\icell}{\itime}{\commoditysymbol} & =\densitymc{\icell}{\itime-1}{\commoditysymbol}+\frac{\deltat}{\deltax}\left(\flowinmc{\icell}{\itime-1}{\commoditysymbol}-\flowoutmc{\icell}{\itime-1}{\commoditysymbol}\right) & \forall\icell\in\left\{\linksetsymbol - \sourcesetsymbol \cup \sinksetsymbol \right\} ,\itime\in\left\{ 1,\ldots,\ntime\right\}, \forall\commoditysymbol\in\commoditysetsymbol
\label{eq:conservationGeneral}
\\
\Hmc{1}{\itime}{\icell}{\commoditysymbol}: && \densitymc{\ncell}{\itime}{\commoditysymbol} & =\densitymc{\ncell}{\itime-1}{\commoditysymbol}+\frac{\deltat}{\deltax}\left(\mbox{\ensuremath{\flowinmc{\ncell}{\itime-1}{\commoditysymbol}}}-\flowoutmc{\ncell}{\itime-1}{\commoditysymbol}\right) & \forall\icell\in\left\{\sinksetsymbol \right\}, \forall\itime\in\left\{ 1,\ldots,\ntime\right\}, \forall\commoditysymbol\in\commoditysetsymbol
\label{eq:conservationSink}
\end{align}
\label{eq:conservation}
\end{subequations}
with initial condition 
\begin{align}
\I{1}{\icell}{\commoditysymbol} : \densitymc{\icell}0{\commoditysymbol} =\densityinitmc{\icell}{\commoditysymbol} && \forall\icell\in\left\{\linksetsymbol - \sourcesetsymbol \right\}, \forall\commoditysymbol\in\commoditysetsymbol
\tag{I1}
\label{eq:densityInit}
\end{align}

\noindent \textbf{Boundary conditions}
\begin{align}
\Hmc{2}{\itime}{\icell}{\commoditysymbol}: && \boundaryqueuemc{\icell}{\itime}{\commoditysymbol} & =\boundaryqueuemc{\icell}{\itime-1}{\commoditysymbol}+\deltat\left(\inputfluxmc{\icell}{\itime-1}{\commoditysymbol}-\flowoutmc{\icell}{\itime-1}{\commoditysymbol}\right) & \forall\icell\in\sourcesetsymbol ,\itime\in\left\{ 1,\ldots,\ntime\right\}, \forall\commoditysymbol\in\commoditysetsymbol
\label{eq:sourceConservation}
\end{align}
with initial condition
\begin{align}
\I{2}{\icell}{\commoditysymbol}: \boundaryqueuemc{\icell}0{\commoditysymbol} & =\boundaryqueueinitmc{\icell}{\commoditysymbol} & \forall\icell\in\sourcesetsymbol, \forall\commoditysymbol\in\commoditysetsymbol
\tag{I2}\label{eq:sourceInit}
\end{align}


\noindent \textbf{Flow propagation}\\

\noindent Let, $\density{\icell}{\itime} = \sum_{c=1}^{C}\densitymc{\icell}{\itime}{\commoditysymbol}$
\begin{subequations}
\begin{align}
\stdH{3}: && \celldemand{\icell}{\itime} & =\min\left(\fmax{\icell},\ffspeed{\icell}\density{\icell}{\itime}\right) & \forall\icell\in\left\{\linksetsymbol - \sourcesetsymbol \cup \sinksetsymbol \right\} ,\itime\in\left\{ 0,\ldots,\ntime-1\right\}
\label{eq:junctionDemand} 
\\
\stdH{3}: && \celldemand{\icell}{\itime} & =\min\left(\fmax{\icell},\boundaryqueue{\icell}{\itime}\right) & \forall\icell\in\left\{\sourcesetsymbol\right\} ,\itime\in\left\{ 0,\ldots,\ntime-1\right\}
\label{eq:junctionDemandSource}
\end{align}
\end{subequations}

\begin{subequations}
\begin{align}
\stdH{4}: && \cellsupply{\icell}{\itime} & =\min\left(\fmax{\icell},\congspeed{\icell}\left(\jamdensity{\icell}-\density{\icell}{\itime}\right)\right) & \forall\icell\in\left\{\linksetsymbol - \sourcesetsymbol \cup \sinksetsymbol \right\} ,\itime\in\left\{ 0,\ldots,\ntime-1\right\} 
\label{eq:junctionSupply}  
\\
\stdH{4}: && \cellsupply{\icell}{\itime} & =\fmax{\icell} & \forall\icell\in\left\{\sinksetsymbol \right\} ,\itime\in\left\{ 0,\ldots,\ntime-1\right\} 
\label{eq:junctionSupplySink}  
\end{align}
\end{subequations}

\noindent \textbf{Junction solution}\\

\noindent At junctions, the flows are given by the solver described in section~\ref{sec:junctionModelForOpt}. \\

To simplify the notation, we use the following shorthand:
\begin{itemize}
\item drop the time index $k$
\item $\celldemandnt{1}{\itime} = \celldemandnt{\icell_1}{\itime}$,
$\celldemandnt{2}{\itime} = \celldemandnt{\icell_2}{\itime}$
\item $\cellsupplynt{1}{\itime} = \cellsupplynt{j_1}{\itime}$, 
$\cellsupplynt{1}{\itime} = \cellsupplynt{j_2}{\itime}$
\item $\priority{1} = \priority{\icell_1}$, 
$\priority{2} = \priority{\icell_2}$
\end{itemize}

Let the aggregate split ratio,
	\[
	\aggsplitrationt{i}{j}{k} = \frac{1}{\densitynt{i}{k}} \sum_{c=1}^C \densitymcnt{i}{k}{c}\splitrationt{i}{j}{k}{c} 
	\]

	\indent \indent  \textit{Flow out of incoming links by commodity:}
	\begin{subequations}
	\begin{align}
	\Hmc{5}{\itime}{i}{c}: && \flowoutmcnt{i}{k}{c} =& \frac{\densitymcnt{1}{k}{c}}{\densitynt{1}{k}}\min\left(\frac{\cellsupplynt{1}{k}}{\aggsplitrationt{1}{1}{k}}, \frac{\cellsupplynt{2}{k}}{\aggsplitrationt{1}{2}{k}}, \celldemandnt{1}{k}\right) \ \ \ \ \forall{\icell\in{\cal J}^{in}_{1 \times 2}} 
	\label{eq:junctionFlowOutMaximization12} \\
	\Hmc{5}{\itime}{i}{c}: && \flowoutmcnt{\icell}{\itime}{\commoditysymbol}=& \frac{\densitymcnt{1}{k}{c}}{\densitynt{1}{k}}\begin{cases}
	\celldemandnt{1}{\itime} 
	& \text{if } \frac{1-\priority{1}}{\priority{1}} < \frac{ \min\left( \celldemandnt{2}{\itime}, {\frac{\cellsupplynt{1}{\itime} - \aggsplitrationt{1}{1}{k}\celldemandnt{1}{\itime}}{\aggsplitrationt{2}{1}{k}}}\right)}
	{\celldemand{1}{\itime}}
	\\
\min\left( \celldemandnt{1}{\itime}, {\frac{\cellsupplynt{1}{\itime} - \aggsplitrationt{2}{1}{k}\celldemandnt{2}{\itime}}{\aggsplitrationt{1}{1}{k}}}\right)	& \text{if } \frac{1-\priority{1}}{\priority{1}} > \frac{{\celldemandnt{2}{\itime}}}{\min\left( \celldemandnt{1}{\itime}, {\frac{\cellsupplynt{1}{\itime} - \aggsplitrationt{2}{1}{k}\celldemandnt{2}{\itime}}{\aggsplitrationt{1}{1}{k}}}\right)}
	\\
	\priority{1}\min\left( \celldemandnt{1}{\itime}, {\frac{\priority{1}\cellsupplynt{1}{\itime}}{\priority{1}\aggsplitrationt{1}{1}{k} + \left(1-\priority{1}\right)\aggsplitrationt{2}{1}{k}}}\right) & \text{otherwise }
	\end{cases} \ \ \ \ \forall{i\in{\cal J}^{in}_{2 \times 1}} 
	\label{eq:junctionFlowOutMaximization21} \\
	\Hmc{5}{\itime}{i}{c}: && \flowoutmcnt{\icell}{\itime}{\commoditysymbol}=& \frac{\densitymcnt{1}{k}{c}}{\densitynt{1}{k}}\begin{cases}
	\celldemandnt{1}{\itime} 
	& \text{if } \frac{1-\priority{1}}{\priority{1}} < \frac{ \min\left( \celldemandnt{2}{\itime}, {\frac{\cellsupplynt{1}{\itime} - \aggsplitrationt{1}{1}{k}\celldemandnt{1}{\itime}}{\aggsplitrationt{2}{1}{k}}},{\frac{\cellsupplynt{2}{\itime} - \aggsplitrationt{1}{2}{k}\celldemandnt{1}{\itime}}{\aggsplitrationt{2}{2}{k}}}\right)}
	{\celldemand{1}{\itime}}
	\\
\min\left( \celldemandnt{1}{\itime}, {\frac{\cellsupplynt{1}{\itime} - \aggsplitrationt{2}{1}{k}\celldemandnt{2}{\itime}}{\aggsplitrationt{1}{1}{k}}},{\frac{\cellsupplynt{2}{\itime} - \aggsplitrationt{2}{2}{k}\celldemandnt{2}{\itime}}{\aggsplitrationt{1}{2}{k}}}\right)	& \text{if } \frac{1-\priority{1}}{\priority{1}} > \frac{{\celldemandnt{2}{\itime}}}{\min\left( \celldemandnt{1}{\itime}, {\frac{\cellsupplynt{1}{\itime} - \aggsplitrationt{2}{1}{k}\celldemandnt{2}{\itime}}{\aggsplitrationt{1}{1}{k}}},{\frac{\cellsupplynt{2}{\itime} - \aggsplitrationt{2}{2}{k}\celldemandnt{2}{\itime}}{\aggsplitrationt{1}{2}{k}}}\right)}
	\\
	\priority{1}\min\left( \celldemandnt{1}{\itime}, {\frac{\priority{1}\cellsupplynt{1}{\itime}}{\priority{1}\aggsplitrationt{1}{1}{k} + \left(1-\priority{1}\right)\aggsplitrationt{2}{1}{k}}},{\frac{\priority{1}\cellsupplynt{2}{\itime}}{\priority{1}\aggsplitrationt{1}{2}{k} + \left(1-\priority{1}\right)\aggsplitrationt{2}{2}{k}}}\right) & \text{otherwise }
	\end{cases} \ \ \ \ \forall{i\in{\cal J}^{in}_{2 \times 2}} 
	\label{eq:junctionFlowOutMaximization22}
	\end{align}
	\end{subequations}
	\indent \indent  \textit{Flow in to outgoing links by commodity:}
	\[
	\flowinmcnt{j}{k}{c} = \sum_{i:(i,j)\in A} \splitrationt{i}{j}{k}{c} \flowoutmcnt{i}{k}{c} \ \ \ \ \forall{j\in\{1,2\}, c\in C}
	\]
