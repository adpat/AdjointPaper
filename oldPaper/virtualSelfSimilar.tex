% !TEX root = rampMeteringViaTheAdjoint.tex
\input{contJunctionFigure}
Reference Figure~\ref{fig:contJuncIll} for the notation used in the current junction problem. Let $\fluxsymbol, \densitysymbol$ be the vector notation for fluxes and densities on the links respectively. Let the ($\rsind{}$) notation denote variables pertaining to a Riemann solution, and let the ($\virtualind{}$) notation denote variables pertaining to the \emph{virtual} junction problem. Let $\maxflux_i$ denote the maximum flux allowed from or into a link $i$, depending on the context. For instance, $\virtualind{\rsind{\maxflux}}_{\linkmltwo}$ would be the maximum flux allowed into link $\linkmltwo$ for the virtual junction problem, considering the state given from the Riemann solution of the initial data $\densitysymbol$.

Define the mapping from densities and ramp queues to maximum flux as $\feasibleflux \left(\densitysymbol, \rampqueuesymbol_{\linkon}, \rampcontrolsymbol_{\linkon} \right) = \maxflux$, where the maximum fluxes are determined as in Section~\ref{sec:problemFormulation}.

Define the mapping from our maximum fluxes $\maxflux$ to a ``virtual''
flux $\virtualind{\maxflux}$:

\[
\virtualind{\maxflux}_{i}=\virtualmap{\maxflux_{i},\offrampratiosymbol}=\begin{cases}
\left(1-\offrampratiosymbol\right)\maxflux_{i} & i=\linkmlone\\
\maxflux_{i} & \text{o.w.}
\end{cases}
\]


Define the virtual junction flux solver as $\jsvirt{\virtualind{\maxflux},\prioritysymbol}=\virtualind{\fluxsymbol}$,
which takes the virtual demands from the incoming mainline and ramp
and the supply of the outgoing mainline, as well as a priority factor
$\prioritysymbol$, and produces resultant fluxes $\virtualind{\fluxsymbol}$
by applying the flow maximization criteria across a 2-to-1 merge model
of \cite{garavello2006traffic}. 
\begin{lem}
\label{lem:max-flow-js}$\sum\jsvirt{\virtualind{\maxflux},\prioritysymbol}=2\left(\min\left(\maxflux_{\linkmlone}\left(1-\beta\right)+\maxflux_{\linkon},\maxflux_{\linkmltwo}\right)\right)$\end{lem}
\begin{proof}
Result of flow maximization criteria and the virtual mapping $\virtualmap{}$.
\end{proof}
Let the limiting side, $\limitingside$ ($\negate{\limitingside}$
being the complement), being either \emph{demand-limited} ($\demandlimited$) or \emph{supply-limited} ($\supplylimited$), be defined
by:

\[
\limitingside\left(\maxflux\right)=\begin{cases}
\demandlimited & \maxflux_{\linkmltwo}<\maxflux_{\linkmlone}\left(1-\beta\right)+\maxflux_{\linkon}\\
\supplylimited & \text{otherwise}
\end{cases}
\]


The definition is modified for the virtual problem to be:

\[
\virtualind{\limitingside}\left(\virtualind{\maxflux}\right)=\begin{cases}
\demandlimited & \virtualind{\maxflux}_{\linkmltwo}<\virtualind{\maxflux}_{\linkmlone}+\virtualind{\maxflux}_{\linkon}\\
\supplylimited & \text{otherwise}
\end{cases}
\]

\begin{lem}
\label{lem:lsprime-equals-ls-1}$\limitingside\left(\maxflux\right)=\virtualind{\limitingside}\left(\virtualmap{\maxflux}\right)$\end{lem}
\begin{proof}
From the $\limitingside,\virtualind{\limitingside}$ definitions and
the definition of the virtual map $\virtualmap{}$.
\end{proof}
Define the mapping from initial density $\densitysymbol$ and resultant
flux $\fluxsymbol$ to link-boundary density $\rsind{\densitysymbol}$
as $\rsinrhomap{\fluxsymbol,\densitysymbol}$ or $\rsoutrhomap{\fluxsymbol,\densitysymbol}$,
and let these definitions match \cite{garavello2006traffic}.

We can now define or Riemann solver $\RS{\densitysymbol_{\linkmlone},\densitysymbol_{\linkmltwo},\rampqueuesymbol_{\linkon},\rampcontrolsymbol,\offrampratiosymbol,\priority{},\totalrampflowsymbol}=\left(\rsind{\densitysymbol}_{\linkmlone},\rsind{\densitysymbol}_{\linkmltwo},\fluxsymbol_{\linkon} \right)$.
Determined by the following process:
\begin{enumerate}
\item Determine demands and supplies $\maxflux = \feasibleflux \left(\densitysymbol, \rampqueuesymbol, \rampcontrolsymbol \right)$ for the mainlines and ramp.
\item Map to virtual fluxes $\virtualind{\maxflux}=\virtualmap{\maxflux}$
\item Apply the virtual junction solver $\virtualind{\fluxsymbol}=\jsvirt{\virtualind{\maxflux}}$
\item Map back to standard fluxes $\fluxsymbol=\invvirtualmap{\virtualind{\fluxsymbol}}$
\item Solve for boundary densities $\rsinrhomap{\fluxsymbol_{\linkmlone},\densitysymbol_{\linkmlone}}$,
$\rsoutrhomap{\fluxsymbol_{\linkmltwo},\densitysymbol_{\linkmltwo}}$,
ramp flow $\fluxsymbol_{\linkon}$ and offramp flow $\offrampratiosymbol\fluxsymbol_{\linkmlone}$
\end{enumerate}
Existence and uniqueness of the outputs of $\RS{\cdot}$ are given
by the existence and uniqueness of our virtual mapping functions $\virtualmap{\cdot},\invvirtualmap{\cdot}$
and the results of~\cite{garavello2006traffic}. The density profile
solution is also admissible in the sense of \cite{garavello2006traffic},
as the split ratio matrix is satisfied, there is flow conservation
across the junction (Rankine-Huginiot condition at junctions), and
the density profiles within cells are consistent with the weak solution
of the LWR equation. What we have left to show is that our Riemann
solver is self-similar, or more specifically:

\[
\RS{\rsind{\densitysymbol}_{\linkmlone},\rsind{\densitysymbol}_{\linkmltwo},\rampqueuesymbol_{\linkon},\rampcontrolsymbol,\offrampratiosymbol,\priority{},\totalrampflowsymbol}=\RS{\densitysymbol_{\linkmlone},\densitysymbol_{\linkmltwo},\rampqueuesymbol_{\linkon},\rampcontrolsymbol,\offrampratiosymbol,\priority{},\totalrampflowsymbol}=\left(\rsind{\densitysymbol}_{\linkmlone},\rsind{\densitysymbol}_{\linkmltwo},\fluxsymbol_{\linkon}\right)
\]


We note that the onramp's demand is the same for both expressions
above and it uses the $\fluxsymbol_{\linkon}$ value to updates its
queue length $\rampqueuesymbol$:

\[
\dot{\rampqueuesymbol}=\totalrampflowsymbol-\fluxsymbol_{\linkon}
\]


To show the self-similar property, we show that we can equivalently
demonstrate that the virtual flux out of link $\linkmlone$ is self-similar
in the virtual junction solver $\jsvirt{\cdot}$. 
\begin{lem}
\label{lem:maxed-flux}$\fluxsymbol=\maxflux\implies\rsind{\feasibleflux}=\feasibleflux$, 
\end{lem}

\begin{lem}
\label{lem:supset-ls-not}$\rsind{\feasibleflux}_{\negate{\limitingside}}\supseteq\feasibleflux_{\negate{\limitingside}}$
\end{lem}

\begin{lem}
\label{lem:supset-ls}$\rsind{\feasibleflux}_{\limitingside}=\feasibleflux_{\limitingside}$\end{lem}
\begin{proof}
From definition of $\rsinrhomap{\fluxsymbol,\densitysymbol}$ and
$\rsoutrhomap{\fluxsymbol,\densitysymbol}$.\end{proof}
\begin{lem}
\label{lem:ls-rs-equals-ls}$\rsind{\virtualind{\limitingside}}=\virtualind{\limitingside}$\end{lem}
\begin{proof}
From Lemmas~\ref{lem:supset-ls-not}, \ref{lem:supset-ls}\end{proof}
\begin{lem}
$\rsind{\virtualind{\fluxsymbol}}_{\linkmltwo}=\virtualind{\fluxsymbol}_{\linkmltwo}$\label{lem:equal-flux-two}\end{lem}
\begin{proof}
From Lemma~\ref{lem:supset-ls}, \ref{lem:ls-rs-equals-ls} and
flow maximization in Lemma~\ref{lem:max-flow-js}, we have that the
total flux across the junction for the Riemann solution is identical
to the initial problem.\end{proof}
\begin{lem}
\label{lem:match-flux-virtual}If \textup{$\rsind{\virtualind{\fluxsymbol}}_{\linkmlone}=\virtualind{\fluxsymbol}_{\linkmlone}$,
then $\RS{\cdot}$ is self-similar.}\end{lem}
\begin{proof}
From Lemma~\ref{lem:equal-flux-two}, we have $\rsind{\virtualind{\fluxsymbol}}_{\linkmlone}=\virtualind{\fluxsymbol}_{\linkmlone}\implies\rsind{\virtualind{\fluxsymbol}}=\virtualind{\fluxsymbol}$. Clearly, $\rsind{\rsind{\fluxsymbol}}_{\linkon} = \rsind{\fluxsymbol}_{\linkon}$.
Now we show show $\rsind{\virtualind{\fluxsymbol}}=\virtualind{\fluxsymbol}$
implies the Riemann solver is self-similar. The $\rsind{\densitysymbol}$
solutions have the property that $\rsind{\densitysymbol}\left(\fnflux{\rsind{\densitysymbol}},\rsind{\densitysymbol}\right)=\rsind{\densitysymbol}$,
and $\fnflux{\rsind{\densitysymbol}}=\fluxsymbol$. From the uniqueness
of the inverse virtual mapping $\invvirtualmap{\cdot}$, $\rsind{\virtualind{\fluxsymbol}}=\virtualind{\fluxsymbol}\implies\rsind{\fluxsymbol}=\fluxsymbol$. Therefore,
\begin{align}
\virtualind{\rsind{\fluxsymbol}} = \virtualind{\fluxsymbol} & \implies \\
\rsind{\fluxsymbol} = \fluxsymbol & \implies \\
\rsind{\densitysymbol}\left(\rsind{\fluxsymbol},\rsind{\densitysymbol} \right) = 
\rsind{\densitysymbol}\left(\fluxsymbol,\rsind{\densitysymbol} \right) = 
\rsind{\densitysymbol}\left(\fnflux{\rsind{\densitysymbol}},\rsind{\densitysymbol} \right) =
\rsind{\densitysymbol}
\end{align}
\end{proof}
\begin{thm}
\textup{\label{thm:one-equals-one}$\RS{\cdot}$ is self-similar.}
\end{thm}
We need to show $\rsind{\virtualind{\fluxsymbol}}_{\linkmlone}=\virtualind{\fluxsymbol}_{\linkmlone}$.
When the problem is demand-limited, it is obvious using Lemmas~\ref{lem:supset-ls}
and \ref{lem:ls-rs-equals-ls}. When the problem is supply-limited,
we give some properties. The virtual incoming fluxes are determined
by $\jsvirt{\cdot}$ by minimizing the Euclidean distance of $\left(\fluxsymbol_{\linkmlone,}\fluxsymbol_{\linkon,}\right)$
from $\left(\prioritysymbol\maxflux_{\linkmltwo},\maxflux_{\fluxsymbol}-\prioritysymbol\maxflux_{\linkmltwo}\right)$
such that $\left(\fluxsymbol_{\linkmlone,}\fluxsymbol_{\linkon,}\right)$
is feasible. Note that the reference point $\left(\prioritysymbol\maxflux_{\linkmltwo},\maxflux_{\fluxsymbol}-\prioritysymbol\maxflux_{\linkmltwo}\right)$
will not change with assumption of being supply-limited. Additionally,
Lemma~\ref{lem:supset-ls-not} tells us the feasible set of $\left(\fluxsymbol_{\linkmlone,}\fluxsymbol_{\linkon,}\right)$
only increases.

We consider the case when $\fluxsymbol_{\linkmlone}<\maxflux_{\linkmlone},\fluxsymbol_{\linkon}<\maxflux_{\linkon},$
and otherwise. For the first case, the reference point is feasible,
and thus reference point will be optimal for both the original and
final problem.

Otherwise, one of the incoming links $i$ is at $\maxflux_{i}$, and
the optimal point of the initial problem resides on the boundary of
the feasible region. Lemma~\ref{lem:maxed-flux} tells us the maxed
link's demand will not change. Combined with the fact that the feasible
region of the demands for the virtual junction problem in the Riemann
solution $\left(\maxflux'_{\linkmlone},\maxflux'_{\linkon}\right)$
only increases (from Lemma~\ref{lem:supset-ls-not}), the optimal
point of the junction problem will remain at the same boundary point.

For all cases, we have demonstrated $\virtualind{\fluxsymbol}_{\linkmlone}=\fluxsymbol_{\linkmlone}$,
thus completing the proof. See Figure~\ref{fig:virtualSSFigure} for an illustration of this proof.

\input{virtualSSFigure}
