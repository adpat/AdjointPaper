% !TEX root = rampMeteringViaTheAdjoint.tex

We use gradient descent algorithm (to be determined). We are given an initial  density, $\densityinit{\icell}$ and initial queue lengths $\rampqueueinit{\icell}$.
\begin{itemize}
\item start from an initial feasible control $u^{(0)} \in \mathcal{U}$ (e.g. given by  setting the ramp control at the maximal rate $\rampcontrol{\icell}{\itime} = \rampcontrolMax{\icell}$ $\forall \icell \in \{1, \dots, \ncell-1\}$ and $\forall \itime \in \{0, \dots, \ntime\}$).
\item Until convergence: we use superscript $(p)$ for variables at step $p$
\begin{itemize}
\item forward simulate to compute the corresponding state $x^{(p)}$ induced by control $u^{(p)}$, i.e. solve $H(x^{(p)}, u^{(p)}) = 0$
\item compute the adjoint $\lambda^{(p)}(\itime), \itime \in \{0, \dots, \ntime \}$ by solving the adjoint equations
\item use the adjoint to compute the gradient $\nabla_u J(x^{(p)}, u^{(p)})$
\item update the control $u^{(p+1)} = u^{(p)} - t^{(p)} \nabla_u J(x^{(p)}, u^{(p)})$. Here $t^{(p)}$ is the step size and can be determined using line search.
\end{itemize}
\end{itemize}

\subsection{Avoiding local minima when the control parameter $\rampcontrol{\icell}{\itime} > \rampqueue{\icell}{\itime}$}

From equation(\ref{eq:gradient2}) we have,
\[
\nabla_u J(x,u) = \frac{\partial J}{\partial u} + \lambda^T\frac{\partial H}{\partial u}
\]

\noindent In section~\ref{sec:gradient} we showed that,
\[
\frac{\partial J}{\partial u} = 0 \\
\]

\noindent and $\frac{\partial H}{\partial u}$ only having non-zero entries for constraint $H^5$ 
\[
\frac{\partial H^5_{\itime, \icell}}{\partial u_\icell(\itime)} = \ind{\rampcontrol{\icell}{\itime} < \rampqueue{\icell}{\itime}}
\]

\noindent Thus, the system can get stuck at a local minimum when $u_i(k) > l_i(k)$. To avoid this problem we add a penalty term to the objective function that forces the solution to a point where $u_i(k) \le l_i(k)$. The modified objective function is as follows.
\[
J(x, u) = \sum_{\itime = 0}^{\ntime} \left( \sum_{\icell = 0}^{\ncell} \density{\icell}{\itime} + \sum_{\icell = 1}^{\ncell - 1}  \rampqueue{\icell}{\itime} \right) + 
R \sum_{\itime = 0}^{\ntime-1} \sum_{\icell = 1}^{\ncell - 1} \max{(u_i(k)-l_i(k),0)}
\]
where $R$ is a constant that regulates the magnitude of the penalty. Now,
\[
\frac{\partial J}{\partial u_i(k)} = R\left( u_i(k) - l_i(k) \right) \cdot \ind{u_i(k) \ge l_i(k)}
\]






