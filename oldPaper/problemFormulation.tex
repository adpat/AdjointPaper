% !TEX root = rampMeteringViaTheAdjoint.tex

\subsection{Nomenclature}

\input{nomenclature}

%-----------------------------------------------------------------------------------------------------------------------------------------------------------------
\subsection{System description}

We consider a discretization of the continuous system described in Section~\ref{sec:continuous_problem}, using the Godunov scheme. A diagram describing the system is given in fig.~\ref{fig:system}. Discrete time is indexed by $\itime \in \{0, \dots, \ntime \}$. The mainline is divided into $\ncell$ cells, indexed by $\icell \in \{1, \dots, \ncell\}$. The density on cell~$\icell$ at time step $\itime$ is given by $\density{\icell}{\itime}$. The incoming (respectively outgoing) flux to cell~$\icell$ at time step~$\itime$ is given by $\flowin{\icell}{\itime}$ (respectively $\flowout{\icell}{\itime}$). We add a ghost cell at the entrance of the network, cell $\icell = 0$, to impose the boundary flow, or flow demand, given at time step~$\itime$ by~$\inputflux{0}{\itime}$. Each cell~$\icell \in \{1, \dots, \ncell-1\}$ is followed by a two-two junction (referred to as junction~$\icell$), that connects the mainline to an on-ramp and an off-ramp (referred to as on-ramp~$\icell$ and off-ramp~$\icell$). The flow demand from the off-ramp is determined by the control $\rampcontrol{\icell}{\itime}$ (that is the maximum flux out of the ramp) and the car count $\rampqueue{\icell}{\itime}$ on the ramp. The junction flows are determined in the same way as in the continuous system. On-ramp~$\icell$ is subject to flux input (or flux demand) given by the sequence~$(\inputflux{\icell}{\itime})_{\itime}$.

\begin{figure}[h]
\centering
\resizebox{\columnwidth}{!}{\input{TikZ/systemTikz}}
\caption{Flow variables and boundary flows in the system.}
\label{fig:system}
\end{figure}

\subsubsection{Choosing the correct space and time discretization}

TODO: Add the CFL conditions and discuss how to select the proper cell size. Smaller cells will violate the CFL condition and larger cells will cause numerical inaccuracies when vehicles need more that one time step to pass through the cell in free flow. 





%-----------------------------------------------------------------------------------------------------------------------------------------------------------------
\subsection{System equations}

\input{systemequations}

%-----------------------------------------------------------------------------------------------------------------------------------------------------------------
\subsection{Ordering of state vector and constraints}

\input{ordering}

%-----------------------------------------------------------------------------------------------------------------------------------------------------------------

\subsection{Forward simulation}
\input{forwardSimulation}

%-----------------------------------------------------------------------------------------------------------------------------------------------------------------
\subsection{Objective function}
TODO: generalize this to include total travel distance.\\
TODO: cars have to be flushed out of the network at the end of the $\ntime$ time steps. Discuss how this is done.

The objective function is the total travel time, given by
\[
J(x, u) = \sum_{\itime = 0}^{\ntime} \left( \sum_{\icell = 0}^{\ncell} \density{\icell}{\itime} + \sum_{\icell = 1}^{\ncell - 1} \rampqueue{\icell}{\itime} \right)
\]


%-----------------------------------------------------------------------------------------------------------------------------------------------------------------
\subsection{Adjoint system}
\input{adjointeq.tex}
\input{adjointeq2.tex}


%-----------------------------------------------------------------------------------------------------------------------------------------------------------------
\subsection{Computing the gradient}
\label{sec:gradient}
After solving for $\lambda$ (adjoint system), we can compute the gradient, given formally by
\[
\nabla_u J (x, u)
= \frac{\partial J}{\partial u} + \lambda^T \frac{\partial H}{\partial u}
\]

Since the objective function $J$ does not depend on the control parameter $u$, we have
\begin{equation*}
\frac{\partial J}{\partial u} = 0
\end{equation*}

The system constraints $H$ have only one equation \ref{eq:junctionRampDemand} that depends on the control $u$. Therefore, the derivative of all other constraints with respect to the control $u$ is zero.
\begin{equation}
\frac{\partial \H{5}{\itime}{\icell} }{\partial u_i(k)} = -\ind{l_i(k) > u_i(k)}
\end{equation}

