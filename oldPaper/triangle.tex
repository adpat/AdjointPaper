% !TEX root = rampMeteringViaTheAdjoint.tex
\input{triangletikz}

In this section, we detail the triangular nature of our forward-simulation system by showing a dependency diagram of the variables with respect to time, variable type, and cell type. The dependency chain is given in Figure~\ref{fig:triangle}. Initial densities and ramp queues have no dependencies, since they are input into the system. From these values, all variables related to demand ($\celldemandsymbol,\cellsupplysymbol,\rampdemandsymbol$) for time step 0 can be determined with no dependency on the cell type. All variables for time step 0 can be determined by following the dependency chart. Once time step 0 is known, then all of time step 1 can be determined. This process can be repeated for all time steps, at which point all variables are known.

Since the system is piecewise-affine (see~\cite{Thai}), the next timestep $x_{\itime}$ can be calculated by $A_m x_{\itime - 1} + b_m$, where $m$ is the "mode" of the system at time step $\itime - 1$. The mode, and in turn the $A,b$ matrices, is only determined after a "forward simulation" step is done on the previous time step. This process can be repeated for every time step, and we thus know the Jacobian $\frac{\partial H}{\partial x}$ matrix to be constant, if the entire state of the system is known. Furthermore, since all variables can be determined from previously solved variables (Figure~\ref{fig:triangle}), we know the structure of this matrix to be lower-triangular if the state vector is topologically ordered.

While this may appear to be circuitous (to use knowledge of the entire state of the system to determine how the system will evolve), the adjoint system assumes complete knowledge of the state. Therefore, without any forward-simulation step, the entire $\frac{\partial H}{\partial x}$ matrix can be solved (and is constant). The adjoint variables are determined as the solution of Equation~\ref{eq:adjointEquation}, which is a system of linear equation for our case. Furthermore, the transpose of $\frac{\partial H}{\partial x}$ is an upper triangular matrix, and can therefore be efficiently solved using back-substitution. The sparsity of the $\frac{\partial H}{\partial x}$ matrix allows us to use even more efficient solution methods, which explicitly use the dependency diagram in Figure~\ref{fig:triangle}.